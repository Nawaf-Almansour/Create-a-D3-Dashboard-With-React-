{"ast":null,"code":"import _slicedToArray from\"/Users/nawaf/code/Create-a-D3-Dashboard-With-React-/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import{D3_TRANSITION_DURATION,MAP_DIMENSIONS,MAP_LEGEND_HEIGHT,MAP_VIZS,STATISTIC_CONFIGS}from'../constants';import{formatNumber,spike}from'../utils/commonFunctions';import{range,quantile}from'd3-array';import{axisRight,axisBottom}from'd3-axis';import{format}from'd3-format';import{interpolate,interpolateRound,quantize}from'd3-interpolate';import{scaleLinear,scaleOrdinal,scaleBand}from'd3-scale';import{select}from'd3-selection';import{transition}from'd3-transition';import{useEffect,useRef}from'react';import{useTranslation}from'react-i18next';import{useMeasure}from'react-use';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";function MapLegend(_ref){var data=_ref.data,statistic=_ref.statistic,mapViz=_ref.mapViz,mapScale=_ref.mapScale;var _useTranslation=useTranslation(),t=_useTranslation.t;var svgLegendRef=useRef(null);var svgLegendChoroRef=useRef(null);var _useMeasure=useMeasure(),_useMeasure2=_slicedToArray(_useMeasure,2),wrapperRef=_useMeasure2[0],width=_useMeasure2[1].width;useEffect(function(){var t=transition().duration(D3_TRANSITION_DURATION);if(mapViz!==MAP_VIZS.CHOROPLETH){var svg=select(svgLegendChoroRef.current);svg.select('.ramp').transition(t).attr('opacity',0).attr('display','none').attr('xlink:href',null);svg.select('.bars').selectAll('rect').transition(t).attr('opacity',0).remove();svg.selectAll('.axis > *:not(.axistext)').remove();svg.select('.axistext').text('');}if(mapViz!==MAP_VIZS.BUBBLE){var _svg=select(svgLegendRef.current);_svg.select('.circles').selectAll('circle').transition(t).attr('r',0).attr('cy',0).remove();_svg.selectAll('.circle-axis > *').remove();}if(mapViz!==MAP_VIZS.SPIKES){var _svg2=select(svgLegendRef.current);_svg2.select('.spikes').call(function(g){return g.selectAll('path').transition(t).attr('d',spike(0)).remove();}).call(function(g){return g.selectAll('text').remove();}).transition(t).selectAll('g').remove();_svg2.selectAll('.spike-axis > *').remove();}},[mapViz]);useEffect(function(){if(!width)return;var statisticConfig=STATISTIC_CONFIGS[statistic];var zoom=width/MAP_DIMENSIONS[0];if(mapViz===MAP_VIZS.BUBBLE){var svg=select(svgLegendRef.current);var _mapScale$domain=mapScale.domain(),_mapScale$domain2=_slicedToArray(_mapScale$domain,2),domainMax=_mapScale$domain2[1];var _legend=svg.select('.circles').attr('transform',\"translate(48,40)\").attr('text-anchor','middle');var legendRadius=[0.1,0.4,1].map(function(d){return d*domainMax;});_legend.selectAll('circle').data(legendRadius).join('circle').attr('fill','none').attr('stroke',statisticConfig.color+'70').transition(t).attr('cy',function(d){return-mapScale(d);}).attr('r',function(d){return mapScale(d);});var yScale=mapScale.copy().range([0,-2*mapScale(domainMax)]);svg.select('.circle-axis').attr('transform',\"translate(48,50)\").transition(t).call(axisRight(yScale).tickSize(0).tickPadding(0).tickValues(legendRadius).tickFormat(function(num){return formatNumber(num,statisticConfig.format==='long'?'short':statisticConfig.format);})).selectAll('.tick text').style('text-anchor','middle').attr('font-size',10/zoom);svg.select('.circle-axis').call(function(g){return g.select('.domain').remove();});}else if(mapViz===MAP_VIZS.SPIKE){var _svg3=select(svgLegendRef.current);var ticks=mapScale.ticks(3).slice(1).reverse();var gap=28/zoom;_svg3.select('.spikes').attr('transform',\"translate(32,24)\").selectAll('g').data(ticks).join(function(enter){return enter.append('g').call(function(g){return g.append('path').attr('fill-opacity',0.3).attr('d',function(d){return spike(0);});});}).attr('transform',function(d,i){return\"translate(\".concat(i*gap,\",0)\");}).call(function(g){return g.select('path').transition(t).attr('d',function(d){return spike(mapScale(d));}).attr('fill',statisticConfig.color+'70').attr('stroke',statisticConfig.color+'70');});var xScale=mapScale.copy().range([gap*ticks.length,0]);_svg3.select('.spike-axis').attr('transform',\"translate(32,32)\").transition(t).call(axisBottom(xScale).tickSize(0).tickPadding(0).tickValues(ticks).tickFormat(function(num){return formatNumber(num,statisticConfig.format==='long'?'short':statisticConfig.format);})).selectAll('.tick text').style('text-anchor','middle').attr('font-size',10/zoom);_svg3.select('.spike-axis').call(function(g){return g.select('.domain').remove();});}else{var _statisticConfig$mapC2;var _svg4=select(svgLegendChoroRef.current);_svg4.call(function(){return legend({svg:_svg4,color:mapScale,width:width,height:MAP_LEGEND_HEIGHT,ticks:5,tickFormat:function tickFormat(d,i,n){var _statisticConfig$mapC;if(statisticConfig===null||statisticConfig===void 0?void 0:(_statisticConfig$mapC=statisticConfig.mapConfig)===null||_statisticConfig$mapC===void 0?void 0:_statisticConfig$mapC.colorScale){return d;}else if(mapViz===MAP_VIZS.CHOROPLETH&&!Number.isInteger(d)){return'';}else if(i===n.length-1){return formatNumber(d,statisticConfig.format)+'+';}else{return formatNumber(d,statisticConfig.format);}},marginLeft:2,marginRight:0});});_svg4.attr('class',(statisticConfig===null||statisticConfig===void 0?void 0:(_statisticConfig$mapC2=statisticConfig.mapConfig)===null||_statisticConfig$mapC2===void 0?void 0:_statisticConfig$mapC2.colorScale)?'zone':'');}},[t,width,statistic,mapScale,mapViz]);return/*#__PURE__*/_jsxs(\"div\",{className:\"svg-parent maplegend\",ref:wrapperRef,style:{height:2*MAP_LEGEND_HEIGHT},children:[/*#__PURE__*/_jsxs(\"svg\",{id:\"legend\",preserveAspectRatio:\"xMinYMid meet\",ref:svgLegendRef,viewBox:\"0 0 \".concat(MAP_DIMENSIONS[0],\" \").concat(MAP_LEGEND_HEIGHT),children:[/*#__PURE__*/_jsx(\"g\",{className:\"circles\"}),/*#__PURE__*/_jsx(\"g\",{className:\"spikes\"}),/*#__PURE__*/_jsx(\"g\",{className:\"circle-axis\"}),/*#__PURE__*/_jsx(\"g\",{className:\"spike-axis\"}),/*#__PURE__*/_jsx(\"g\",{className:\"axis\",children:/*#__PURE__*/_jsx(\"text\",{className:\"axistext\"})})]}),/*#__PURE__*/_jsxs(\"svg\",{id:\"legend-choro\",preserveAspectRatio:\"xMinYMid meet\",ref:svgLegendChoroRef,children:[/*#__PURE__*/_jsx(\"image\",{className:\"ramp\",preserveAspectRatio:\"none\"}),/*#__PURE__*/_jsx(\"g\",{className:\"bars\"}),/*#__PURE__*/_jsx(\"g\",{className:\"axis\",children:/*#__PURE__*/_jsx(\"text\",{className:\"axistext\"})})]}),/*#__PURE__*/_jsx(\"canvas\",{className:\"color-scale\",style:{position:'absolute',height:0}})]});}export default MapLegend;function legend(){var _ref2=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},svg=_ref2.svg,color=_ref2.color,title=_ref2.title,_ref2$tickSize=_ref2.tickSize,tickSize=_ref2$tickSize===void 0?6:_ref2$tickSize,_ref2$width=_ref2.width,width=_ref2$width===void 0?320:_ref2$width,_ref2$height=_ref2.height,height=_ref2$height===void 0?44+tickSize:_ref2$height,_ref2$marginTop=_ref2.marginTop,marginTop=_ref2$marginTop===void 0?18:_ref2$marginTop,_ref2$marginRight=_ref2.marginRight,marginRight=_ref2$marginRight===void 0?0:_ref2$marginRight,_ref2$marginBottom=_ref2.marginBottom,marginBottom=_ref2$marginBottom===void 0?16+tickSize:_ref2$marginBottom,_ref2$marginLeft=_ref2.marginLeft,marginLeft=_ref2$marginLeft===void 0?0:_ref2$marginLeft,_ref2$ticks=_ref2.ticks,ticks=_ref2$ticks===void 0?width/64:_ref2$ticks,tickFormat=_ref2.tickFormat,tickValues=_ref2.tickValues,ordinalWeights=_ref2.ordinalWeights;var t=svg.transition().duration(D3_TRANSITION_DURATION);var tickAdjust=function tickAdjust(g){var ticks=g.selectAll('.tick line');ticks.attr('y1',marginTop+marginBottom-height);// select(ticks.nodes()[ticks.size() - 1]).remove();\n};var x;// Continuous\nif(color.interpolate){var n=Math.min(color.domain().length,color.range().length);x=color.copy().rangeRound(quantize(interpolate(marginLeft,width-marginRight),n));svg.select('.ramp').attr('x',marginLeft).attr('y',marginTop).attr('width',width-marginLeft-marginRight).attr('height',height-marginTop-marginBottom).attr('xlink:href',ramp(color.copy().domain(quantize(interpolate(0,1),n))).toDataURL());}// Sequential\nelse if(color.interpolator){svg.select('.bars').selectAll('rect').transition(t).attr('opacity',0).remove();x=Object.assign(color.copy().interpolator(interpolateRound(marginLeft,width-marginRight)),{range:function range(){return[marginLeft,width-marginRight];}});svg.select('.ramp').attr('x',marginLeft).attr('y',marginTop).attr('width',width-marginLeft-marginRight).attr('height',height-marginTop-marginBottom).attr('xlink:href',ramp(color.interpolator()).toDataURL()).attr('display','visible').transition(t).attr('opacity',1);// scaleSequentialQuantile doesn’t implement ticks or tickFormat.\nif(!x.ticks){if(tickValues===undefined){var _n=Math.round(ticks+1);tickValues=range(_n).map(function(i){return quantile(color.domain(),i/(_n-1));});}if(typeof tickFormat!=='function'){tickFormat=format(tickFormat===undefined?',f':tickFormat);}}}// Threshold\nelse if(color.invertExtent){var thresholds=color.thresholds?color.thresholds()// scaleQuantize\n:color.quantiles?color.quantiles()// scaleQuantile\n:color.domain();// scaleThreshold\nvar thresholdFormat=tickFormat===undefined?function(d){return d;}:typeof tickFormat==='string'?format(tickFormat):tickFormat;x=scaleLinear().domain([-1,color.range().length-1]).rangeRound([marginLeft,width-marginRight]);svg.append('g').selectAll('rect').data(color.range()).join('rect').attr('x',function(d,i){return x(i-1);}).attr('y',marginTop).attr('width',function(d,i){return x(i)-x(i-1);}).attr('height',height-marginTop-marginBottom).attr('fill',function(d){return d;});tickValues=range(-1,thresholds.length);tickFormat=function tickFormat(i){if(i===-1)return thresholdFormat(1);else if(i===thresholds.length-1)return;else if(i===thresholds.length-2)return thresholdFormat(thresholds[i]+'+',i);return thresholdFormat(thresholds[i],i);};}// Ordinal\nelse{svg.select('.ramp').transition(t).attr('opacity',0).attr('xlink:href',null);if(!ordinalWeights){x=scaleBand().domain(color.domain().filter(function(d){return d;})).rangeRound([marginLeft,width-marginRight]);svg.select('.bars').selectAll('rect').data(color.domain().filter(function(d){return d;})).join('rect').attr('x',x).attr('y',marginTop).attr('width',Math.max(0,x.bandwidth()-1)).attr('height',height-marginTop-marginBottom).attr('fill',color);}else{var widthScale=scaleLinear().domain([0,ordinalWeights.reduce(function(a,b){return a+b;})]).rangeRound([0,width-marginLeft-marginRight]);var xPos=ordinalWeights.map(function(w,i){return ordinalWeights.slice(0,i).reduce(function(acc,w){return acc+widthScale(w);},marginLeft);});x=scaleOrdinal().domain(color.domain()).range(xPos);svg.select('.bars').selectAll('rect').data(color.domain()).join(function(enter){return enter.append('rect').attr('x',x).attr('width',function(d,i){return widthScale(ordinalWeights[i]);});}).attr('y',marginTop).attr('height',height-marginTop-marginBottom).attr('fill',color).transition(t).attr('x',x).attr('width',function(d,i){return widthScale(ordinalWeights[i]);}).attr('opacity',1);}tickAdjust=function tickAdjust(){};}svg.select('.axis').attr('transform',\"translate(0,\".concat(height-marginBottom,\")\")).transition(t).attr('class','axis').call(axisBottom(x).ticks(ticks,typeof tickFormat==='string'?tickFormat:undefined).tickFormat(typeof tickFormat==='function'?tickFormat:undefined).tickSize(tickSize).tickValues(tickValues)).on('start',function(){svg.call(tickAdjust).call(function(svg){return svg.select('.domain').remove();});}).call(function(g){return g.select('.axistext').attr('class','axistext').attr('x',marginLeft).attr('y',marginTop+marginBottom-height-6).attr('fill','currentColor').attr('text-anchor','start').attr('font-weight','bold').text(title);});return svg.node();}function ramp(color){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:256;var canvas=select('.color-scale').node();var context=(canvas.width=n,canvas.height=1,canvas).getContext('2d');for(var i=0;i<n;++i){context.fillStyle=color(i/(n-1));context.fillRect(i,0,1,1);}return canvas;}","map":{"version":3,"sources":["/Users/nawaf/code/Create-a-D3-Dashboard-With-React-/src/components/MapLegend.js"],"names":["D3_TRANSITION_DURATION","MAP_DIMENSIONS","MAP_LEGEND_HEIGHT","MAP_VIZS","STATISTIC_CONFIGS","formatNumber","spike","range","quantile","axisRight","axisBottom","format","interpolate","interpolateRound","quantize","scaleLinear","scaleOrdinal","scaleBand","select","transition","useEffect","useRef","useTranslation","useMeasure","MapLegend","data","statistic","mapViz","mapScale","t","svgLegendRef","svgLegendChoroRef","wrapperRef","width","duration","CHOROPLETH","svg","current","attr","selectAll","remove","text","BUBBLE","SPIKES","call","g","statisticConfig","zoom","domain","domainMax","legend","legendRadius","map","d","join","color","yScale","copy","tickSize","tickPadding","tickValues","tickFormat","num","style","SPIKE","ticks","slice","reverse","gap","enter","append","i","xScale","length","height","n","mapConfig","colorScale","Number","isInteger","marginLeft","marginRight","position","title","marginTop","marginBottom","ordinalWeights","tickAdjust","x","Math","min","rangeRound","ramp","toDataURL","interpolator","Object","assign","undefined","round","invertExtent","thresholds","quantiles","thresholdFormat","filter","max","bandwidth","widthScale","reduce","a","b","xPos","w","acc","on","node","canvas","context","getContext","fillStyle","fillRect"],"mappings":"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","sourcesContent":["import {\n  D3_TRANSITION_DURATION,\n  MAP_DIMENSIONS,\n  MAP_LEGEND_HEIGHT,\n  MAP_VIZS,\n  STATISTIC_CONFIGS,\n} from '../constants';\nimport {formatNumber, spike} from '../utils/commonFunctions';\n\nimport {range, quantile} from 'd3-array';\nimport {axisRight, axisBottom} from 'd3-axis';\nimport {format} from 'd3-format';\nimport {interpolate, interpolateRound, quantize} from 'd3-interpolate';\nimport {scaleLinear, scaleOrdinal, scaleBand} from 'd3-scale';\nimport {select} from 'd3-selection';\nimport {transition} from 'd3-transition';\nimport {useEffect, useRef} from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {useMeasure} from 'react-use';\n\nfunction MapLegend({data, statistic, mapViz, mapScale}) {\n  const {t} = useTranslation();\n  const svgLegendRef = useRef(null);\n  const svgLegendChoroRef = useRef(null);\n  const [wrapperRef, {width}] = useMeasure();\n\n  useEffect(() => {\n    const t = transition().duration(D3_TRANSITION_DURATION);\n\n    if (mapViz !== MAP_VIZS.CHOROPLETH) {\n      const svg = select(svgLegendChoroRef.current);\n      svg\n        .select('.ramp')\n        .transition(t)\n        .attr('opacity', 0)\n        .attr('display', 'none')\n        .attr('xlink:href', null);\n\n      svg\n        .select('.bars')\n        .selectAll('rect')\n        .transition(t)\n        .attr('opacity', 0)\n        .remove();\n      svg.selectAll('.axis > *:not(.axistext)').remove();\n      svg.select('.axistext').text('');\n    }\n\n    if (mapViz !== MAP_VIZS.BUBBLE) {\n      const svg = select(svgLegendRef.current);\n      svg\n        .select('.circles')\n        .selectAll('circle')\n        .transition(t)\n        .attr('r', 0)\n        .attr('cy', 0)\n        .remove();\n      svg.selectAll('.circle-axis > *').remove();\n    }\n\n    if (mapViz !== MAP_VIZS.SPIKES) {\n      const svg = select(svgLegendRef.current);\n      svg\n        .select('.spikes')\n        .call((g) =>\n          g.selectAll('path').transition(t).attr('d', spike(0)).remove()\n        )\n        .call((g) => g.selectAll('text').remove())\n        .transition(t)\n        .selectAll('g')\n        .remove();\n      svg.selectAll('.spike-axis > *').remove();\n    }\n  }, [mapViz]);\n\n  useEffect(() => {\n    if (!width) return;\n\n    const statisticConfig = STATISTIC_CONFIGS[statistic];\n    const zoom = width / MAP_DIMENSIONS[0];\n\n    if (mapViz === MAP_VIZS.BUBBLE) {\n      const svg = select(svgLegendRef.current);\n\n      const [, domainMax] = mapScale.domain();\n\n      const legend = svg\n        .select('.circles')\n        .attr('transform', `translate(48,40)`)\n        .attr('text-anchor', 'middle');\n\n      const legendRadius = [0.1, 0.4, 1].map((d) => d * domainMax);\n\n      legend\n        .selectAll('circle')\n        .data(legendRadius)\n        .join('circle')\n        .attr('fill', 'none')\n        .attr('stroke', statisticConfig.color + '70')\n        .transition(t)\n        .attr('cy', (d) => -mapScale(d))\n        .attr('r', (d) => mapScale(d));\n\n      const yScale = mapScale.copy().range([0, -2 * mapScale(domainMax)]);\n\n      svg\n        .select('.circle-axis')\n        .attr('transform', `translate(48,50)`)\n        .transition(t)\n        .call(\n          axisRight(yScale)\n            .tickSize(0)\n            .tickPadding(0)\n            .tickValues(legendRadius)\n            .tickFormat((num) =>\n              formatNumber(\n                num,\n                statisticConfig.format === 'long'\n                  ? 'short'\n                  : statisticConfig.format\n              )\n            )\n        )\n        .selectAll('.tick text')\n        .style('text-anchor', 'middle')\n        .attr('font-size', 10 / zoom);\n\n      svg.select('.circle-axis').call((g) => g.select('.domain').remove());\n    } else if (mapViz === MAP_VIZS.SPIKE) {\n      const svg = select(svgLegendRef.current);\n      const ticks = mapScale.ticks(3).slice(1).reverse();\n\n      const gap = 28 / zoom;\n\n      svg\n        .select('.spikes')\n        .attr('transform', `translate(32,24)`)\n        .selectAll('g')\n        .data(ticks)\n        .join((enter) =>\n          enter.append('g').call((g) =>\n            g\n              .append('path')\n              .attr('fill-opacity', 0.3)\n              .attr('d', (d) => spike(0))\n          )\n        )\n        .attr('transform', (d, i) => `translate(${i * gap},0)`)\n        .call((g) =>\n          g\n            .select('path')\n            .transition(t)\n            .attr('d', (d) => spike(mapScale(d)))\n            .attr('fill', statisticConfig.color + '70')\n            .attr('stroke', statisticConfig.color + '70')\n        );\n\n      const xScale = mapScale.copy().range([gap * ticks.length, 0]);\n      svg\n        .select('.spike-axis')\n        .attr('transform', `translate(32,32)`)\n        .transition(t)\n        .call(\n          axisBottom(xScale)\n            .tickSize(0)\n            .tickPadding(0)\n            .tickValues(ticks)\n            .tickFormat((num) =>\n              formatNumber(\n                num,\n                statisticConfig.format === 'long'\n                  ? 'short'\n                  : statisticConfig.format\n              )\n            )\n        )\n        .selectAll('.tick text')\n        .style('text-anchor', 'middle')\n        .attr('font-size', 10 / zoom);\n\n      svg.select('.spike-axis').call((g) => g.select('.domain').remove());\n    } else {\n      const svg = select(svgLegendChoroRef.current);\n      svg.call(() =>\n        legend({\n          svg: svg,\n          color: mapScale,\n          width: width,\n          height: MAP_LEGEND_HEIGHT,\n          ticks: 5,\n          tickFormat: function (d, i, n) {\n            if (statisticConfig?.mapConfig?.colorScale) {\n              return d;\n            } else if (mapViz === MAP_VIZS.CHOROPLETH && !Number.isInteger(d)) {\n              return '';\n            } else if (i === n.length - 1) {\n              return formatNumber(d, statisticConfig.format) + '+';\n            } else {\n              return formatNumber(d, statisticConfig.format);\n            }\n          },\n          marginLeft: 2,\n          marginRight: 0,\n        })\n      );\n      svg.attr('class', statisticConfig?.mapConfig?.colorScale ? 'zone' : '');\n    }\n  }, [t, width, statistic, mapScale, mapViz]);\n\n  return (\n    <div\n      className=\"svg-parent maplegend\"\n      ref={wrapperRef}\n      style={{height: 2 * MAP_LEGEND_HEIGHT}}\n    >\n      <svg\n        id=\"legend\"\n        preserveAspectRatio=\"xMinYMid meet\"\n        ref={svgLegendRef}\n        viewBox={`0 0 ${MAP_DIMENSIONS[0]} ${MAP_LEGEND_HEIGHT}`}\n      >\n        <g className=\"circles\"></g>\n        <g className=\"spikes\"></g>\n        <g className=\"circle-axis\"></g>\n        <g className=\"spike-axis\"></g>\n        <g className=\"axis\">\n          <text className=\"axistext\" />\n        </g>\n      </svg>\n      <svg\n        id=\"legend-choro\"\n        preserveAspectRatio=\"xMinYMid meet\"\n        ref={svgLegendChoroRef}\n      >\n        <image className=\"ramp\" preserveAspectRatio=\"none\" />\n        <g className=\"bars\"></g>\n        <g className=\"axis\">\n          <text className=\"axistext\" />\n        </g>\n      </svg>\n      <canvas\n        className=\"color-scale\"\n        style={{position: 'absolute', height: 0}}\n      />\n    </div>\n  );\n}\n\nexport default MapLegend;\n\nfunction legend({\n  svg,\n  color,\n  title,\n  tickSize = 6,\n  width = 320,\n  height = 44 + tickSize,\n  marginTop = 18,\n  marginRight = 0,\n  marginBottom = 16 + tickSize,\n  marginLeft = 0,\n  ticks = width / 64,\n  tickFormat,\n  tickValues,\n  ordinalWeights,\n} = {}) {\n  const t = svg.transition().duration(D3_TRANSITION_DURATION);\n\n  let tickAdjust = (g) => {\n    const ticks = g.selectAll('.tick line');\n    ticks.attr('y1', marginTop + marginBottom - height);\n    // select(ticks.nodes()[ticks.size() - 1]).remove();\n  };\n  let x;\n\n  // Continuous\n  if (color.interpolate) {\n    const n = Math.min(color.domain().length, color.range().length);\n\n    x = color\n      .copy()\n      .rangeRound(quantize(interpolate(marginLeft, width - marginRight), n));\n\n    svg\n      .select('.ramp')\n      .attr('x', marginLeft)\n      .attr('y', marginTop)\n      .attr('width', width - marginLeft - marginRight)\n      .attr('height', height - marginTop - marginBottom)\n      .attr(\n        'xlink:href',\n        ramp(color.copy().domain(quantize(interpolate(0, 1), n))).toDataURL()\n      );\n  }\n\n  // Sequential\n  else if (color.interpolator) {\n    svg\n      .select('.bars')\n      .selectAll('rect')\n      .transition(t)\n      .attr('opacity', 0)\n      .remove();\n\n    x = Object.assign(\n      color\n        .copy()\n        .interpolator(interpolateRound(marginLeft, width - marginRight)),\n      {\n        range() {\n          return [marginLeft, width - marginRight];\n        },\n      }\n    );\n\n    svg\n      .select('.ramp')\n      .attr('x', marginLeft)\n      .attr('y', marginTop)\n      .attr('width', width - marginLeft - marginRight)\n      .attr('height', height - marginTop - marginBottom)\n      .attr('xlink:href', ramp(color.interpolator()).toDataURL())\n      .attr('display', 'visible')\n      .transition(t)\n      .attr('opacity', 1);\n\n    // scaleSequentialQuantile doesn’t implement ticks or tickFormat.\n    if (!x.ticks) {\n      if (tickValues === undefined) {\n        const n = Math.round(ticks + 1);\n        tickValues = range(n).map((i) => quantile(color.domain(), i / (n - 1)));\n      }\n      if (typeof tickFormat !== 'function') {\n        tickFormat = format(tickFormat === undefined ? ',f' : tickFormat);\n      }\n    }\n  }\n\n  // Threshold\n  else if (color.invertExtent) {\n    const thresholds = color.thresholds\n      ? color.thresholds() // scaleQuantize\n      : color.quantiles\n      ? color.quantiles() // scaleQuantile\n      : color.domain(); // scaleThreshold\n\n    const thresholdFormat =\n      tickFormat === undefined\n        ? (d) => d\n        : typeof tickFormat === 'string'\n        ? format(tickFormat)\n        : tickFormat;\n\n    x = scaleLinear()\n      .domain([-1, color.range().length - 1])\n      .rangeRound([marginLeft, width - marginRight]);\n\n    svg\n      .append('g')\n      .selectAll('rect')\n      .data(color.range())\n      .join('rect')\n      .attr('x', (d, i) => x(i - 1))\n      .attr('y', marginTop)\n      .attr('width', (d, i) => x(i) - x(i - 1))\n      .attr('height', height - marginTop - marginBottom)\n      .attr('fill', (d) => d);\n\n    tickValues = range(-1, thresholds.length);\n    tickFormat = (i) => {\n      if (i === -1) return thresholdFormat(1);\n      else if (i === thresholds.length - 1) return;\n      else if (i === thresholds.length - 2)\n        return thresholdFormat(thresholds[i] + '+', i);\n      return thresholdFormat(thresholds[i], i);\n    };\n  }\n\n  // Ordinal\n  else {\n    svg\n      .select('.ramp')\n      .transition(t)\n      .attr('opacity', 0)\n      .attr('xlink:href', null);\n    if (!ordinalWeights) {\n      x = scaleBand()\n        .domain(color.domain().filter((d) => d))\n        .rangeRound([marginLeft, width - marginRight]);\n      svg\n        .select('.bars')\n        .selectAll('rect')\n        .data(color.domain().filter((d) => d))\n        .join('rect')\n        .attr('x', x)\n        .attr('y', marginTop)\n        .attr('width', Math.max(0, x.bandwidth() - 1))\n        .attr('height', height - marginTop - marginBottom)\n        .attr('fill', color);\n    } else {\n      const widthScale = scaleLinear()\n        .domain([0, ordinalWeights.reduce((a, b) => a + b)])\n        .rangeRound([0, width - marginLeft - marginRight]);\n\n      const xPos = ordinalWeights.map((w, i) =>\n        ordinalWeights\n          .slice(0, i)\n          .reduce((acc, w) => acc + widthScale(w), marginLeft)\n      );\n\n      x = scaleOrdinal().domain(color.domain()).range(xPos);\n\n      svg\n        .select('.bars')\n        .selectAll('rect')\n        .data(color.domain())\n        .join((enter) =>\n          enter\n            .append('rect')\n            .attr('x', x)\n            .attr('width', (d, i) => widthScale(ordinalWeights[i]))\n        )\n        .attr('y', marginTop)\n        .attr('height', height - marginTop - marginBottom)\n        .attr('fill', color)\n        .transition(t)\n        .attr('x', x)\n        .attr('width', (d, i) => widthScale(ordinalWeights[i]))\n        .attr('opacity', 1);\n    }\n\n    tickAdjust = () => {};\n  }\n\n  svg\n    .select('.axis')\n    .attr('transform', `translate(0,${height - marginBottom})`)\n    .transition(t)\n    .attr('class', 'axis')\n    .call(\n      axisBottom(x)\n        .ticks(ticks, typeof tickFormat === 'string' ? tickFormat : undefined)\n        .tickFormat(typeof tickFormat === 'function' ? tickFormat : undefined)\n        .tickSize(tickSize)\n        .tickValues(tickValues)\n    )\n    .on('start', () => {\n      svg.call(tickAdjust).call((svg) => svg.select('.domain').remove());\n    })\n    .call((g) =>\n      g\n        .select('.axistext')\n        .attr('class', 'axistext')\n        .attr('x', marginLeft)\n        .attr('y', marginTop + marginBottom - height - 6)\n        .attr('fill', 'currentColor')\n        .attr('text-anchor', 'start')\n        .attr('font-weight', 'bold')\n        .text(title)\n    );\n\n  return svg.node();\n}\n\nfunction ramp(color, n = 256) {\n  const canvas = select('.color-scale').node();\n  const context = ((canvas.width = n), (canvas.height = 1), canvas).getContext(\n    '2d'\n  );\n  for (let i = 0; i < n; ++i) {\n    context.fillStyle = color(i / (n - 1));\n    context.fillRect(i, 0, 1, 1);\n  }\n  return canvas;\n}\n"]},"metadata":{},"sourceType":"module"}